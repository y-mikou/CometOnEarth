#!/bin/bash

function view_violation () {

    : æ¤œå‡ºã™ã¹ãå†…å®¹ã®å®šç¾© & {
        #3æ–‡å­—ä»¥ä¸‹ã§çµ‚ã‚ã‚‹è¡Œã®ç¢ºèª
        REGEX01='^.{1,3}$'

        #è¡Œé ­ãŒ ã€ã€‚ã€ã€ï¼‰
        REGEX02='^[ã€ã€‚ã€ã€ï¼‰]'

        #æŠ˜ã‚Šè¿”ã—é™ç•Œ-5æ–‡å­—ã«â– (æ¯å­—ã®2å€ä»¥ä¸Šã®ãƒ«ãƒ“)ãŒã‚ã‚‹
        REGEX03="^[^â– ]{$(( ${FOLD_LENGTH} - 5 )),${FOLD_LENGTH}}â– "

    }

    #ç–‘ä¼¼æŠ˜ã‚Šè¿”ã—ãƒ‡ãƒ¼ã‚¿ä½œæˆå‰ã«ã€ä»¥ä¸‹ã‚’å®Ÿæ–½ã™ã‚‹
    ## ã€Šã€Šæ¯å­—ã€‹ã€‹ã‚’æ¯å­—ã®ã¿ã«ã™ã‚‹â€¦â€¦ ã€Šã€Š ã¨ ã€‹ã€‹ ã‚’å‰Šé™¤ã™ã‚‹ã€‚
    ##ã€€ï½œæ¯å­—ã€Šãƒ«ãƒ“æ–‡å­—ã€‹ã‚’ã€æ¯å­—æ•°ã¨ãƒ«ãƒ“æ–‡å­—æ•°ã®2å€ã§é•·ã„æ–¹ã®ã¿ã‚’ä¿æŒã—ã¦ã€ãã†ã§ãªã„æ–¹ã‚’å‰Šé™¤ã™ã‚‹ã€‚
    : ç™ºç”Ÿä»¶æ•° & {

        VIOLATION_COUNT=$(\
            cat "${TARGET_FILE}" \
            | sed -E "s/(.{${FOLD_LENGTH}})/\\1\\n/g" \
            | grep -cE --color=always "(${REGEX01})|(${REGEX02})|(${REGEX03})"
        )
    }

    : è¡¨ç¤ºè¡Œæ•°ã®æ“ä½œ & {

        echo "âœ¨ï¸ç¦å‰‡å‡¦ç†ãƒ»ãã®ä»–ä¿®æ­£å¿…è¦ç®‡æ‰€æ¤œå‡ºãƒ¢ãƒ¼ãƒ‰"

        if [[ -z ${VIEW_COUNT_tmp} ]] ; then
            echo "ðŸ—¨ï¸ è¡¨ç¤ºä»¶æ•°æŒ‡å®šãŒãªã‹ã£ãŸãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®10ä»¶è¡¨ç¤ºã§ã™"
        fi
        VIEW_COUNT=${VIEW_COUNT_tmp:-10}
        echo "ðŸ—¿ å…¨${VIOLATION_COUNT}ç®‡æ‰€(è¡Œ)ä¸­ã€${VIEW_COUNT}ç®‡æ‰€(è¡Œ)åˆ†ã®è­¦å‘Šç®‡æ‰€ã‚’è¡¨ç¤ºã—ã¾ã™"

        if [[ ${VIEW_COUNT} =~ ^[0-9]+-[0-9]+$ ]] ; then
            echo "ðŸš¨ è­¦å‘Š: ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€å¼•æ•°4 (è¡¨ç¤ºæ•°) ã«ç¯„å›²ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ (æŒ‡å®šã•ã‚ŒãŸå€¤: ${VIEW_COUNT})" >&2
            exit 1
        fi
        read -p ">Press Enter<"
        echo "---------------------------------------"
    }

    : æ¤œå‡ºå†…å®¹ & {
        #æŠ½å‡ºè¡Œã¯ã€å‰1è¡Œã€HITè¡Œã€å¾Œ1è¡Œã€åŒºåˆ‡è¡Œã€ã®4è¡Œãªã®ã§ã€çµæžœã®æŠ½å‡ºè¡Œã¯ä»¶æ•°ã®4å€ã§è¨­å®šã™ã‚‹
        if [[ ${VIOLATION_COUNT} -lt ${VIEW_COUNT} ]] ;then
            VIEW_COUNT=${VIOLATION_COUNT}
        fi
        VIEW_ROWS=$(( ${VIEW_COUNT} * 4))

        #ç¢ºèªå¯¾ç§°ã‚’æ¤œå‡º
        cat "${TARGET_FILE}" \
        | sed -E "s/(.{${FOLD_LENGTH}})/\\1\\n/g" \
        | grep -En1 --color=always "(${REGEX01})|(${REGEX02})|(${REGEX03})" \
        | sed -n 1,${VIEW_ROWS}p
    }

    : çµ‚äº†å‡¦ç† & {
        echo "---------------------------------------"
        if [ "$VIOLATION_COUNT" -eq 0 ]; then
            echo "âœ… ç¦å‰‡å‡¦ç†å€™è£œç®‡æ‰€ãªã—ã€ä¿®æ­£å€™è£œç®‡æ‰€ãªã—"
        fi
    }
}

function view_fold () {

    : è¡¨ç¤ºè¡Œæ•°ã®æ“ä½œ & {
        echo "âœ¨ï¸æŠ˜ã‚Šè¿”ã—ç¢ºèªæ©Ÿèƒ½ãƒ¢ãƒ¼ãƒ‰ã€‚"
        if [[ -z ${VIEW_COUNT_tmp} ]] ; then
            echo "ðŸ—¨ï¸ è¡¨ç¤ºä»¶æ•°æŒ‡å®šãŒãªã‹ã£ãŸãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®1âˆ’100è¡Œè¡¨ç¤ºã§ã™"
        fi
        VIEW_COUNT="${VIEW_COUNT_tmp:-1-100}"

        folded_rows_count=$(cat "${TARGET_FILE}" | sed -E "s/(.{${FOLD_LENGTH}})/\\1\\n/g" | wc -l )

        if [[ ${VIEW_COUNT} -eq 0 ]] ; then
            echo "ðŸ—¿æŠ˜è¿”çµæžœã€å…¨è¡Œã‚’è¡¨ç¤ºã—ã¾ã™ã€‚"
        else
            if [[ ${VIEW_COUNT} =~ [0-9]+-[0-9]+ ]] ; then
                startLine=$(echo ${VIEW_COUNT} | cut -d '-' -f 1)
                endLine=$(echo ${VIEW_COUNT} | cut -d '-' -f 2)
                comnd="${startLine},${endLine}p"
                echo "ðŸ—¿æŠ˜è¿”çµæžœã€å…¨${folded_rows_count}è¡Œä¸­ã®${startLine}è¡Œç›®ã€œ${endLine}è¡Œç›®ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚"
            else
                comnd="1,${VIEW_COUNT}p"
                echo "ðŸ—¿æŠ˜è¿”çµæžœã€å…¨${folded_rows_count}è¡Œä¸­ã®1è¡Œç›®ã€œ${VIEW_COUNT}è¡Œç›®ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚"
            fi
        fi

        read -p ">Press Enter<"
        echo "---------------------------------------"
    }

    #ç–‘ä¼¼æŠ˜ã‚Šè¿”ã—ãƒ‡ãƒ¼ã‚¿ä½œæˆå‰ã«ã€ä»¥ä¸‹ã‚’å®Ÿæ–½ã™ã‚‹
    ## ã€Šã€Šæ¯å­—ã€‹ã€‹ã‚’æ¯å­—ã®ã¿ã«ã™ã‚‹â€¦â€¦ ã€Šã€Š ã¨ ã€‹ã€‹ ã‚’å‰Šé™¤ã™ã‚‹ã€‚
    ##ã€€ï½œæ¯å­—ã€Šãƒ«ãƒ“æ–‡å­—ã€‹ã‚’ã€æ¯å­—æ•°ã¨ãƒ«ãƒ“æ–‡å­—æ•°ã®2å€ã§é•·ã„æ–¹ã®ã¿ã‚’ä¿æŒã—ã¦ã€ãã†ã§ãªã„æ–¹ã‚’å‰Šé™¤ã™ã‚‹ã€‚
    : æŠ˜ã‚Šè¿”ã—è¡¨ç¤ºå®Ÿè¡Œ & {
        #æŠ½å‡ºè¡Œã¯ã€å‰1è¡Œã€HITè¡Œã€å¾Œ1è¡Œã€åŒºåˆ‡è¡Œã€ã®4è¡Œãªã®ã§ã€çµæžœã®æŠ½å‡ºè¡Œã¯ä»¶æ•°ã®4å€ã§è¨­å®šã™ã‚‹
        #ç¢ºèªå¯¾ç§°ã‚’æ¤œå‡º

        if [[ ${VIEW_COUNT} -eq 0 ]] ; then
            cat "${TARGET_FILE}" \
            | sed -E "s/(.{${FOLD_LENGTH}})/\\1\\n/g"
        else
            cat "${TARGET_FILE}" \
            | sed -E "s/(.{${FOLD_LENGTH}})/\\1\\n/g" \
            | sed -n ${comnd}
        fi
    }

    : çµ‚äº†å‡¦ç† & {
        echo "---------------------------------------"
    }    
}


###################################################
## ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ãƒã‚¤ãƒ³ãƒˆ
###################################################

: è¨­å®šã¨åˆæœŸåŒ– & {
    TARGET_FILE="$1"
    VIEW_MODE="$2"
    FOLD_LENGTH="$3"
    VIEW_COUNT_tmp="${4}"
    TMP_COUNT=0
    VIOLATION_COUNT=0
}

: å¼•æ•°ãƒã‚§ãƒƒã‚¯ & {
    ## å¼•æ•°2ãŒæ­£ã®æ•´æ•°ã§100ä»¥ä¸‹ã§ã‚ã‚‹ã‹ã®ãƒã‚§ãƒƒã‚¯
    if ! [[ "$FOLD_LENGTH" =~ ^[0-9]+$ ]] || [ "$FOLD_LENGTH" -lt 0 ] || [ "$FOLD_LENGTH" -gt 100 ]; then
        echo "ðŸš¨ è­¦å‘Š: å¼•æ•°3 (æŠ˜è¿”ã—æ–‡å­—æ•°) ã¯ã€0ã‹ã‚‰100ã¾ã§ã®æ­£ã®æ•´æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ (æŒ‡å®šã•ã‚ŒãŸå€¤: $FOLD_LENGTH)" >&2
        exit 1
    fi

    ## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã€èª­ã¿å–ã‚Šå¯èƒ½ã‹
    if [ ! -f "$TARGET_FILE" ] || [ ! -r "$TARGET_FILE" ]; then
        echo "ðŸš¨ è­¦å‘Š: å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ« '$TARGET_FILE' ãŒå­˜åœ¨ã—ãªã„ã‹ã€èª­ã¿å–ã‚Šã§ãã¾ã›ã‚“ã€‚" >&2
        exit 1
    fi

    ## ãƒ¢ãƒ¼ãƒ‰ã®é¸æŠž
    if [[ ! ${VIEW_MODE} =~ [FV] ]]; then
        echo "ðŸš¨ è­¦å‘Š: ãƒ¢ãƒ¼ãƒ‰ã¯ F:æŠ˜è¿”ç¢ºèª V:è­¦å‘Šæ¤œå‡º ã®ã„ãšã‚Œã‹ã«ã—ã¦ãã ã•ã„ã€‚ (æŒ‡å®šã•ã‚ŒãŸå€¤: $VIEW_MODE)" >&2
        exit 1
    fi
}

: å†…å®¹ãƒã‚§ãƒƒã‚¯ & {
    ## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ–‡å­—ã‚³ãƒ¼ãƒ‰utf-8ã§ã‚ã‚‹ã‹
    ENCODING=$(file -i "${TARGET_FILE}" | grep -oP 'charset=[^;]*' | grep -oP "[uU][tT][fF]-*8")
    if [ "$ENCODING" != "utf-8" ]; then
        echo "ðŸš¨ è­¦å‘Š: å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ« ${TARGET_FILE} ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¯utf-8ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ (ç¾åœ¨ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰: ${ENCODING})" >&2
        exit 1
    fi

    ## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã¯lfã§ã‚ã‚‹ã‹
    if grep -q $'\\r' "${TARGET_FILE}"; then
        echo "ðŸš¨ è­¦å‘Š: å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ« ${TARGET_FILE} ã®æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã¯LFã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚CRLFãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚" >&2
        exit 1
    fi
}

case "${VIEW_MODE}" in
    'F')    view_fold
            ;;
    'V')    view_violation
            ;;
    *  ) ;;
esac
